@page "/"
@using GitManager
@using NGitLab.Models
@using System.Collections.Generic
@inject IGitManagerService GitManager
@inject ILogger<GitLabIssueManager> Logger

<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6">GitLab Issue Manager</h1>

    <div class="mb-6">
        <div class="flex gap-4 mb-4">
            <div class="flex-1">
                <label for="projectId" class="block mb-2 font-medium">Project ID</label>
                <input id="projectId" type="number" class="w-full p-2 border rounded" @bind="ProjectId" />
            </div>
            <div class="mt-8">
                <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" @onclick="LoadIssues">
                    Load Issues
                </button>
            </div>
        </div>
    </div>

    @if (Loading)
    {
        <div class="flex justify-center">
            <div class="text-lg">Loading...</div>
        </div>
    }
    else if (ErrorMessage != null)
    {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <strong>Error:</strong> @ErrorMessage
            <button class="ml-2 text-red-700" @onclick="ClearError">×</button>
        </div>
    }

    @if (Issues != null && Issues.Any())
    {
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4">Issues</h2>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left">ID</th>
                            <th class="py-3 px-4 text-left">Title</th>
                            <th class="py-3 px-4 text-left">State</th>
                            <th class="py-3 px-4 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var issue in Issues)
                        {
                            <tr class="border-t">
                                <td class="py-3 px-4">@issue.Id</td>
                                <td class="py-3 px-4">@issue.Title</td>
                                <td class="py-3 px-4">
                                    <span class="@(issue.State == "opened" ? "text-green-600" : "text-red-600")">
                                        @issue.State
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <button class="text-blue-500 hover:underline mr-2" @onclick="() => SelectIssue(issue)">
                                        Edit
                                    </button>
                                    @if (issue.State == "opened")
                                    {
                                        <button class="text-red-500 hover:underline" @onclick="() => CloseIssue(issue.Iid)">
                                            Close
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <div class="bg-gray-50 p-6 rounded-lg shadow mb-8">
        <h2 class="text-xl font-bold mb-4">@(EditingIssue ? "Edit Issue" : "Create New Issue")</h2>

        <div class="mb-4">
            <label for="issueTitle" class="block mb-2 font-medium">Title</label>
            <input id="issueTitle" class="w-full p-2 border rounded" @bind="IssueTitle" />
        </div>

        <div class="mb-4">
            <label for="issueDescription" class="block mb-2 font-medium">Description</label>
            <textarea id="issueDescription" class="w-full p-2 border rounded h-32" @bind="IssueDescription"></textarea>
        </div>

        <div class="mb-4">
            <label for="issueLabels" class="block mb-2 font-medium">Labels (comma-separated)</label>
            <input id="issueLabels" class="w-full p-2 border rounded" @bind="IssueLabels" />
        </div>

        @if (EditingIssue)
        {
            <div class="mb-4">
                <label for="assigneeIds" class="block mb-2 font-medium">Assignee IDs (comma-separated)</label>
                <input id="assigneeIds" class="w-full p-2 border rounded" @bind="AssigneeIdsInput" />
            </div>
        }

        <div class="flex gap-4">
            <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" @onclick="SaveIssue">
                @(EditingIssue ? "Update Issue" : "Create Issue")
            </button>

            @if (EditingIssue)
            {
                <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" @onclick="CancelEdit">
                    Cancel
                </button>
            }
        </div>
    </div>
</div>